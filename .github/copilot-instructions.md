# Diesel Builders Copilot Instructions

## Project Overview
`diesel-builders` is a Rust library that provides a type-safe builder pattern for [Diesel](https://diesel.rs). It specializes in handling complex table relationships such as inheritance chains, DAGs, and triangular dependencies, offering compile-time guarantees for insertion order and referential integrity.

## Architecture
The project is split into two main crates:
- **`diesel-builders`**: Contains the core traits, runtime logic, and re-exports of helper modules. It defines the `Builder`, `TableModel`, and relationship traits.
- **`diesel-builders-derive`**: Contains the procedural macros (`TableModel`, `fk`) that generate the boilerplate code for user-defined structs.

### Key Components
- **`TableModel` Derive Macro**: This is the core of the library. It analyzes the struct and its attributes to generate:
  - **The Diesel `table!` definition** (do NOT write this manually).
  - A builder struct (e.g., `AnimalBuilder`).
  - Implementations of `GetColumn`, `SetColumn`, and other traits.
  - Logic for handling foreign keys and relationships.
- **Builder Pattern**: The generated builders provide a fluent API. They track the state of set columns and ensure all required fields are provided before insertion.
- **Relationship Management**: The library handles complex dependencies automatically.
  - **Inheritance**: `#[table_model(ancestors(parent_table))]`
  - **Triangular Dependencies**: `#[mandatory(other_table)]` and `#[discretionary(other_table)]`
  - **Data Propagation**: `#[same_as(other_table::column)]` ensures consistency across related tables.

## Critical Developer Workflows

### Testing
- **Integration Tests**: The primary way to test the library is through the `tests/` directory in the `diesel-builders` crate.
  - Tests typically use **SQLite in-memory** databases.
  - `shared.rs` and other `shared_*.rs` files provide common setup helpers (connection establishment, schema creation).
- **Running Tests**:
  ```bash
  cargo test
  ```
- **Compile Times**: Use `measure_compile_times.sh` to monitor build performance, as heavy macro usage can impact compile times.

### Debugging Macros
- Since much of the logic is generated by macros, debugging can be tricky.
- If you need to see the generated code, use `cargo expand` (if installed) or carefully inspect the `diesel-builders-derive` source code.
- The `tests/trybuild/` directory (if present) is used for testing macro compilation errors.

## Project-Specific Conventions

### Defining Models
Always derive `TableModel` and standard Diesel traits (`Queryable`, `Selectable`, `Identifiable`).
**CRITICAL**: Do NOT manually define the `diesel::table!`. The `TableModel` derive macro generates the table definition automatically.
```rust
#[derive(Queryable, Selectable, Identifiable, TableModel)]
#[diesel(table_name = animals)]
#[table_model(surrogate_key)] // Use if the table has an auto-incrementing ID
pub struct Animal {
    id: i32,
    name: String,
    #[table_model(default = "Default Value")] // Set default values
    description: Option<String>,
}
```

### Handling Relationships
- **Inheritance**: Use `ancestors` to define parent tables.
  ```rust
  #[table_model(ancestors(animals))]
  pub struct Dog { ... }
  ```
- **Ancestor Defaults**: Use `default(path, value)` on the struct to set default values for ancestor columns.
  ```rust
  #[table_model(ancestors(animals))]
  #[table_model(default(animals::description, "A friendly dog".to_string()))]
  pub struct Dog { ... }
  ```
- **Data Flow (`same_as`)**: Use `same_as` to link columns between tables, ensuring they hold the same value (e.g., propagating a description from a child to a parent).
  ```rust
  #[same_as(animals::description)]
  dog_notes: Option<String>,
  ```
- **Triangular Relations**: Use `mandatory` or `discretionary` for side-tables that are related to both the parent and the child.
  ```rust
  #[mandatory(satellite_table)]
  satellite_id: i32,
  ```

### Builder Usage
- Access the builder via `table::builder()`.
- Use fluent setters for columns.
- Call `insert(&mut conn)` to execute the transaction.
  ```rust
  let animal = animals::table::builder()
      .name("Buddy")
      .insert(&mut conn)?;
  ```

## Integration Points
- **Diesel**: The library is tightly coupled with Diesel. It relies on Diesel's `Table`, `Column`, and connection traits.
- **Serde**: Support for `serde` can be enabled, allowing builders/models to be serialized/deserialized.

## Common Pitfalls
- **Schema Definitions**: Ensure your `diesel::sql_query` or `table!` definitions match the struct fields exactly.
- **Order of Operations**: The builder handles insertion order automatically, but circular dependencies in the schema (without proper `same_as` usage) can lead to issues.
- **Macro Attributes**: Pay close attention to the syntax of `#[table_model(...)]` and `#[same_as(...)]`. Misspellings or incorrect paths will cause compile errors.
